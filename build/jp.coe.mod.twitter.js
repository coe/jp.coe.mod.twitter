var exports=exports||this;function compVersions(n,l){for(var j=0,k=n.split("."),d=l.split("."),f=Math.max(k.length,d.length),c=0;c<f;c++){var a=c<k.length?parseInt(k[c],10):0,b=c<d.length?parseInt(d[c],10):0;isNaN(a)&&(a=0);isNaN(b)&&(b=0);if(a!=b){j=a>b?1:-1;break}}return j}
exports.Twitter=function(){function n(){var a=this,b=this.oauthClient,e=Ti.UI.createWindow({title:this.windowTitle}),c=Ti.UI.createWebView(),g=Ti.UI.createView({backgroundColor:"black",opacity:0.7,zIndex:1}),h=Titanium.UI.createActivityIndicator({height:50,width:10,message:"Loading...",color:"white"}),m=Ti.UI.createButton({title:this.windowClose}),o=Ti.UI.createButton({title:this.windowBack}),i=null;this.webView=c;e.leftNavButton=m;h.show();g.add(h);e.add(g);Ti.API.debug("tiver:"+Titanium.version);
null!=Ti.UI.iOS&&0<=compVersions(Titanium.version,"3.1.3")?(i=Ti.UI.iOS.createNavigationWindow({modal:!0,window:e}),i.open()):e.open({modal:!0});e.add(c);m.addEventListener("click",function(){null!=i&&i.close();e.close();a.fireEvent("cancel",{success:!1,error:"The user cancelled.",result:null})});o.addEventListener("click",function(){c.goBack()});c.addEventListener("beforeload",function(){j||e.add(g);h.show()});c.addEventListener("load",function(c){-1===c.url.indexOf(a.authorizeUrl)?(e.remove(g),
h.hide(),e.leftNavButton!==o&&(e.leftNavButton=o)):(e.leftNavButton!==m&&(e.leftNavButton=m),(c=c.source.evalJS("document.getElementById('oauth_pin').getElementsByTagName('code')[0].innerText"))?(j||(null!=i&&i.close(),e.close()),b.accessTokenUrl="https://api.twitter.com/oauth/access_token?oauth_verifier="+c,b.fetchAccessToken(function(){Ti.App.Properties.setString(d,b.getAccessTokenKey());Ti.App.Properties.setString(f,b.getAccessTokenSecret());a.fireEvent("login",{success:!0,error:!1,accessTokenKey:b.getAccessTokenKey(),
accessTokenSecret:b.getAccessTokenSecret()});a.authorized=!0;j&&(null!=i&&i.close(),e.close())},function(b){a.fireEvent("login",{success:!1,error:"Failure to fetch access token, please try again.",result:b})})):(e.remove(g),h.hide()))})}var l=function(){},j="android"===Ti.Platform.osname,k=require("jp.coe.mod.jsOAuth-1.3.3"),d="twitterAccessTokenKey",f="twitterAccessTokenSecret",c=function(a){var b;b=this instanceof c?this:new l;a||(a={});b.windowTitle=a.windowTitle||"Twitter Authorization";b.windowClose=
a.windowClose||"Close";b.windowBack=a.windowBack||"Back";b.consumerKey=a.consumerKey;b.consumerSecret=a.consumerSecret;b.authorizeUrl="https://api.twitter.com/oauth/authorize";b.accessTokenKey=a.accessTokenKey=Ti.App.Properties.getString(d,"");b.accessTokenSecret=a.accessTokenSecret=Ti.App.Properties.getString(f,"");b.authorized=!1;b.listeners={};b.accessTokenKey&&b.accessTokenSecret&&(b.authorized=!0);a.requestTokenUrl=a.requestTokenUrl||"https://api.twitter.com/oauth/request_token";b.oauthClient=
k.OAuth(a);return b};l.prototype=c.prototype;c.prototype.authorize=function(){var a=this;this.authorized?setTimeout(function(){Ti.App.Properties.setString(d,a.accessTokenKey);Ti.App.Properties.setString(f,a.accessTokenSecret);a.fireEvent("login",{success:!0,error:!1,accessTokenKey:a.accessTokenKey,accessTokenSecret:a.accessTokenSecret})},1):(n.call(this),this.oauthClient.fetchRequestToken(function(b){a.webView.url=a.authorizeUrl+b},function(b){a.fireEvent("login",{success:!1,error:"Failure to fetch access token, please try again.",
result:b})}))};c.prototype.request=function(a,b,c,d,g){var h=this,f=this.oauthClient,a=a.match(/^https?:\/\/.+/i)?a:"https://api.twitter.com/"+a;f.request({method:d,url:a,data:b,headers:c,success:function(a){g.call(h,{success:!0,error:!1,result:a})},failure:function(a){g.call(h,{success:!1,error:"Request failed",result:a})}})};c.prototype.logout=function(a){this.oauthClient.setAccessToken("","");this.accessTokenSecret=this.accessTokenKey=null;this.authorized=!1;Ti.App.Properties.removeProperty(d);
Ti.App.Properties.removeProperty(f);a()};c.prototype.isAuthorized=function(){Ti.API.debug(Ti.App.Properties.getString(d,""));Ti.API.debug(Ti.App.Properties.getString(f,""));return this.authorized};c.prototype.addEventListener=function(a,b){this.listeners=this.listeners||{};this.listeners[a]=this.listeners[a]||[];this.listeners[a].push(b)};c.prototype.fireEvent=function(a,b){for(var c=this.listeners[a]||[],d=0;d<c.length;d++)c[d].call(this,b)};return c}(this);